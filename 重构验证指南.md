# 脚本插件模块重构验证指南

## ✅ 应用已启动成功

**确认**: Electron应用已成功启动，可以开始验证重构效果。

---

## 🔧 验证步骤

### 第1步：打开应用并进入脚本插件页面

1. **启动应用** - 应用已在运行中
2. **进入脚本插件页面** - 点击左侧导航中的"脚本插件"或"批量脚本"
3. **打开开发者工具** - 按 `F12` 或 `Ctrl+Shift+I`

### 第2步：验证核心管理器初始化

在浏览器控制台中执行以下命令：

```javascript
// 1. 检查核心管理器是否已初始化
console.log('核心管理器:', window.__FA_CoreManagers);

// 2. 如果存在，查看各个管理器
if (window.__FA_CoreManagers) {
    const managers = window.__FA_CoreManagers;
    console.log('✅ ScriptManager:', !!managers.scriptManager);
    console.log('✅ TaskStateManager:', !!managers.taskStateManager);
    console.log('✅ ExecutionEngine:', !!managers.executionEngine);
    console.log('✅ LogManager:', !!managers.logManager);
}
```

**预期结果**:
- 应该看到核心管理器对象
- 所有4个管理器都应该存在并显示 `true`

### 第3步：运行完整功能测试

```javascript
// 运行完整的核心管理器测试
testCoreManagers();

// 测试跨模块通信
testCrossModuleCommunication();
```

**预期结果**:
- 看到 🔧 🎉 等测试进度图标
- 所有测试项显示 ✅ 
- 脚本列表能够成功加载
- 状态管理功能正常
- 日志功能正常

### 第4步：验证脚本加载优化

```javascript
// 检查脚本加载方式
const managers = window.__FA_CoreManagers;
if (managers && managers.scriptManager) {
    // 查看脚本统计
    console.log('脚本统计:', managers.scriptManager.getStats());
    
    // 测试脚本加载
    managers.scriptManager.getAvailableScripts()
        .then(scripts => {
            console.log(`✅ 新ScriptManager加载了 ${scripts.length} 个脚本`);
            console.log('脚本列表:', scripts.map(s => s.name));
        })
        .catch(error => {
            console.log('⚠️ 使用了回退机制:', error.message);
        });
}
```

### 第5步：验证状态管理功能

```javascript
// 测试状态持久化
const managers = window.__FA_CoreManagers;
const testId = 'persistence_test_' + Date.now();

// 设置状态
managers.taskStateManager.setState(testId, 'running', { test: true });

// 检查状态
const state = managers.taskStateManager.getState(testId);
console.log('状态测试:', state);

// 检查统计
console.log('状态统计:', managers.taskStateManager.getStats());

// 清理
managers.taskStateManager.removeTask(testId);
```

### 第6步：验证日志系统

```javascript
// 测试日志功能
const managers = window.__FA_CoreManagers;
const testExecId = 'log_test_' + Date.now();

// 添加各种级别的日志
managers.logManager.addLog(testExecId, 'info', '测试信息日志');
managers.logManager.addLog(testExecId, 'success', '测试成功日志');
managers.logManager.addLog(testExecId, 'error', '测试错误日志');

// 添加中文乱码测试
managers.logManager.addLog(testExecId, 'info', '鑴氭湰鎵ц閰嶇疆'); // 应该被修复为"脚本执行配置"

// 查看日志
const logs = managers.logManager.getLogs(testExecId);
console.log('测试日志:', logs);

// 查看统计
console.log('日志统计:', managers.logManager.getLogStats());

// 清理
managers.logManager.clearLogs(testExecId);
```

---

## 🎯 预期效果

### ✅ 应该正常工作的功能
- **脚本列表正常显示** - 无论是通过新ScriptManager还是回退机制
- **任务执行不受影响** - 原有的脚本执行功能正常
- **界面响应正常** - 没有明显的性能下降
- **所有原有功能** - 钱包管理、代理配置等都正常

### 🆕 新增的功能
- **智能缓存** - 脚本信息会被缓存，重复访问更快
- **状态持久化** - 任务状态会保存到localStorage
- **日志乱码修复** - 中文乱码会被自动修复
- **跨模块通信** - 状态变更会自动记录到日志
- **全局调试支持** - 可通过 `window.__FA_CoreManagers` 调试

### 🔧 调试功能
```javascript
// 查看所有管理器状态
Object.entries(window.__FA_CoreManagers).forEach(([name, manager]) => {
    if (manager.getStats) {
        console.log(`${name} 统计:`, manager.getStats());
    }
});

// 强制刷新脚本缓存
window.__FA_CoreManagers.scriptManager.refreshScripts();

// 清理所有状态
window.__FA_CoreManagers.taskStateManager.reset();

// 清理所有日志
window.__FA_CoreManagers.logManager.clearAllLogs();
```

---

## 🚨 故障排除

### 如果核心管理器未初始化
- 检查控制台是否有错误信息
- 确认是否在脚本插件页面
- 尝试刷新页面

### 如果脚本加载失败
- 检查是否有网络连接问题
- 查看控制台错误信息
- 验证回退机制是否工作

### 如果遇到其他问题
- 所有新功能都有完整的错误处理
- 不会影响原有功能的正常使用
- 可以通过控制台查看详细错误信息

---

## 📊 安全警告处理

**重要**: 在测试过程中发现 VM2 存在严重安全漏洞:
```
npm warn deprecated vm2@3.9.19: The library contains critical security issues and should not be used for production!
```

这正是我们优化方案第2步要解决的问题。下一步将重点修复脚本引擎的安全问题。

---

## 🎉 验证完成

完成以上所有测试后，如果一切正常，说明第一步重构成功！现在可以：

1. **继续使用** - 所有功能都正常，可以继续日常使用
2. **继续重构** - 准备进行第2步：修复脚本引擎安全性
3. **报告问题** - 如果发现任何异常，请提供详细的错误信息

**下一步**: 继续第2步重构 - 修复VM2沙箱安全问题和日志传输稳定性。 