/**
 * 中文乱码修复工具
 * 处理特定的中文乱码模式并提供修复功能
 */

/**
 * 中文乱码映射表
 * 存储已知的乱码字符到正确中文字符的映射
 */
const CHINESE_FIX_MAP = {
    '鑴氭湰': '脚本',
    '鎵ц': '执行', 
    '閰嶇疆': '配置',
    '鍒濆鍖?': '初始化',
    '姝ｅ湪': '正在',
    '瀹屾垚': '完成',
    '閽卞寘': '钱包',
    '鑾峰彇': '获取',
    '娣诲姞': '添加',
    '浠ｇ悊': '代理',
    '鎴愬姛': '成功',
    '澶辫触': '失败',
    '鍚姩': '启动',
    '鍋滄': '停止',
    '杩愯': '运行',
    '妫€娴?': '检测',
    '鍔犺浇': '加载',
    '淇濆瓨': '保存',
    '鍒犻櫎': '删除',
    '淇敼': '修改',
    '鏇存柊': '更新',
    '鍒楄〃': '列表',
    '鏁版嵁': '数据',
    '鏂囦欢': '文件',
    '鐩綍': '目录',
    '璺緞': '路径',
    '杩炴帴': '连接',
    '鏂板缓': '新建',
    '涓嬭浇': '下载',
    '涓婁紶': '上传',
    '鍒嗘瀽': '分析',
    '澶勭悊': '处理',
    '鍙戦€?': '发送',
    '鎺ユ敹': '接收',
    '鍝嶅簲': '响应',
    '璇锋眰': '请求',
    '閿欒': '错误',
    '璀﹀憡': '警告',
    '淇℃伅': '信息',
    '璋冭瘯': '调试',
    '鐘舵€?': '状态',
    '缁撴灉': '结果',
    '杩斿洖': '返回',
    '鏁版嵁搴?': '数据库',
    '琛ㄦ牸': '表格',
    '鍒楃殑': '列的',
    '琛岀殑': '行的',
    '鎺掑簭': '排序',
    '绛涢€?': '筛选',
    '鏌ヨ': '查询',
    '鎻掑叆': '插入',
    '绠＄悊鍣?': '管理器',
    '鎺у埗鍙?': '控制台',
    '鏃ュ織': '日志',
    '鍙傛暟': '参数',
    '閫夐」': '选项',
    '璁剧疆': '设置',
    '閰嶇疆椤?': '配置项',
    '鍔熻兘': '功能',
    '妯″潡': '模块',
    '缁勪欢': '组件',
    '鏈嶅姟': '服务',
    '鎺ュ彛': '接口',
    '鏍煎紡': '格式',
    '鍐呭': '内容',
    '瀛楃': '字符',
    '瀛楃涓?': '字符串',
    '鏁板瓧': '数字',
    '甯冨皵': '布尔',
    '鏁扮粍': '数组',
    '瀵硅薄': '对象',
    '鍑芥暟': '函数',
    '鏂规硶': '方法',
    '灞炴€?': '属性',
    '鍊?': '值',
    '閿?': '键',
    '鍚嶇О': '名称',
    '鏍囬': '标题',
    '鎻忚堪': '描述',
    '璇存槑': '说明',
    '甯姪': '帮助',
    '鐗堟湰': '版本',
    '鏇存柊鏃ュ織': '更新日志',
    '鍙戝竷': '发布',
    '涓嬭浇閾炬帴': '下载链接',
    '瀹夎': '安装',
    '鍗歌浇': '卸载',
    '鍚姩椤?': '启动项',
    '闅愯棌': '隐藏',
    '鏄剧ず': '显示',
    '鎵撳紑': '打开',
    '鍏抽棴': '关闭',
    '鏈€澶у寲': '最大化',
    '鏈€灏忓寲': '最小化',
    '鍏ㄥ睆': '全屏',
    '绐楀彛': '窗口',
    '鑿滃崟': '菜单',
    '宸ュ叿鏍?': '工具栏',
    '鐘舵€佹': '状态栏',
    '渚ц竟鏍?': '侧边栏',
    '瀵艰埅': '导航',
    '闈㈡澘': '面板',
    '瀵硅瘽妗?': '对话框',
    '鍏愮ず妗?': '提示框',
    '璀﹀憡妗?': '警告框',
    '纭妗?': '确认框',
    '杈撳叆妗?': '输入框',
    '鎸夐挳': '按钮',
    '閾炬帴': '链接',
    '鏍囩': '标签',
    '琛ㄥ崟': '表单',
    '鍒嗛〉': '分页',
    '鍔犺浇涓?': '加载中',
    '璇峰稍鍚?': '请稍候',
    '姝ｅ湪鍔犺浇': '正在加载',
    '鍔犺浇瀹屾垚': '加载完成',
    '鍔犺浇澶辫触': '加载失败',
    '缃戠粶寮傚父': '网络异常',
    '杩炴帴瓒呮椂': '连接超时',
    '鏈嶅姟鍣ㄩ敊璇?': '服务器错误',
    '鎵句笉鍒?': '找不到',
    '娌℃湁鏉冮檺': '没有权限',
    '宸叉嫆缁?': '已拒绝',
    '宸插彇娑?': '已取消',
    '鎿嶄綔鎴愬姛': '操作成功',
    '鎿嶄綔澶辫触': '操作失败',
    '淇濆瓨鎴愬姛': '保存成功',
    '淇濆瓨澶辫触': '保存失败',
    '鍒犻櫎鎴愬姛': '删除成功',
    '鍒犻櫎澶辫触': '删除失败',
    '澶嶅埗鎴愬姛': '复制成功',
    '澶嶅埗澶辫触': '复制失败',
    '鍒囨崲鎴愬姛': '切换成功',
    '鍒囨崲澶辫触': '切换失败',
    '杩炴帴鎴愬姛': '连接成功',
    '杩炴帴澶辫触': '连接失败',
    '鏂紑杩炴帴': '断开连接',
    '閲嶆柊杩炴帴': '重新连接',
    '鍚屾鎴愬姛': '同步成功',
    '鍚屾澶辫触': '同步失败',
    '澶囦唤鎴愬姛': '备份成功',
    '澶囦唤澶辫触': '备份失败',
    '杩樺師鎴愬姛': '还原成功',
    '杩樺師澶辫触': '还原失败',
    '瀵煎嚭鎴愬姛': '导出成功',
    '瀵煎嚭澶辫触': '导出失败',
    '瀵煎叆鎴愬姛': '导入成功',
    '瀵煎叆澶辫触': '导入失败',
    '璁よ瘉鎴愬姛': '认证成功',
    '璁よ瘉澶辫触': '认证失败',
    '鐧诲綍鎴愬姛': '登录成功',
    '鐧诲綍澶辫触': '登录失败',
    '娉ㄩ攢鎴愬姛': '注销成功',
    '鐧昏娌℃湁鏉冮檺': '登录没有权限',
    '宸茬櫥褰?': '已登录',
    '鏈櫥褰?': '未登录',
    '浼氳瘽杩囨湡': '会话过期',
    '璇烽噸鏂扮櫥褰?': '请重新登录',
    '瀵嗙爜閿欒': '密码错误',
    '鐢ㄦ埛鍚嶉敊璇?': '用户名错误',
    '璐︽埛涓嶅瓨鍦?': '账户不存在',
    '璐︽埛宸插瓨鍦?': '账户已存在',
    '璐︽埛宸茶鍐荤粨': '账户已被冻结',
    '璐︽埛宸茶绂佺敤': '账户已被禁用',
    '鎿嶄綔澶憄': '操作太频繁',
    '璇风◢鍚庡啀璇?': '请稍后再试',
    '鏁版嵁涓嶅瓨鍦?': '数据不存在',
    '鏁版嵁宸插瓨鍦?': '数据已存在',
    '鏁版嵁宸茶繃鏈?': '数据已过期',
    '鏁版嵁鏍煎紡閿欒': '数据格式错误',
    '鍙傛暟閿欒': '参数错误',
    '鍙傛暟缂哄け': '参数缺失',
    '鍙傛暟鏃犳晥': '参数无效',
    '鏍煎紡涓嶆敮鎸?': '格式不支持',
    '鏂囦欢涓嶅瓨鍦?': '文件不存在',
    '鏂囦欢宸插瓨鍦?': '文件已存在',
    '鏂囦欢澶?': '文件过大',
    '鏂囦欢澶?': '文件过小',
    '鏂囦欢鎹熷潖': '文件损坏',
    '鏂囦欢鏍煎紡涓嶆敮鎸?': '文件格式不支持',
    '纾佺洏绌洪棿涓嶈冻': '磁盘空间不足',
    '鍐呭瓨涓嶈冻': '内存不足',
    'CPU鍗犵敤杩囬珮': 'CPU占用过高',
    '缃戠粶涓嶇ǔ瀹?': '网络不稳定',
    '淇″彿涓嶈壇': '信号不良',
    '鐢垫睜鐢甸噺浣?': '电池电量低',
    '鍏呯數鍣ㄦ湭杩炴帴': '充电器未连接',
    '鎬ц兘浼樺寲涓?': '性能优化中',
    '娓呯悊缂撳瓨涓?': '清理缓存中',
    '鎵弿鐥呮瘨涓?': '扫描病毒中',
    '绯荤粺鍗囩骇涓?': '系统升级中',
    '瀹夊叏妫€娴嬩腑': '安全检测中',
    '鍗囩骇瀹屾垚': '升级完成',
    '妫€娴嬪畬鎴?': '检测完成',
    '浼樺寲瀹屾垚': '优化完成',
    '娓呯悊瀹屾垚': '清理完成',
    '鎵弿瀹屾垚': '扫描完成',
    '澶囦唤瀹屾垚': '备份完成',
    '杩樺師瀹屾垚': '还原完成',
    '瀹夎瀹屾垚': '安装完成',
    '鍗歌浇瀹屾垚': '卸载完成',
    '閰嶇疆瀹屾垚': '配置完成',
    '鍒濆鍖栧畬鎴?': '初始化完成',
    '钀ч敊': '错误',
    '鍒嗘瀽': '分析',
    '鍙傝€?': '参考',
    '宸ュ叿': '工具',
    '鐢ㄦ埛': '用户',
    '绠＄悊': '管理',
    '娓呮櫚': '清楚',
    '瀹屾垚': '完成',
    '鍙互': '可以',
    '涓嶅彲浠?': '不可以',
    '璁稿彲': '许可',
    '绂佹': '禁止',
    '鍏佽': '允许',
    '閮ㄧ讲': '部署',
    '鍙戝竷': '发布',
    '绠$悊鍣?': '管理器',
    '绯荤粺': '系统',
    '杞欢': '软件',
    '纭欢': '硬件',
    '鍐呮牳': '内核',
    '椹卞姩': '驱动',
    '搴旂敤': '应用',
    '绋嬪簭': '程序',
    '杩涚▼': '进程',
    '绾跨▼': '线程',
    '浠诲姟': '任务',
    '闃熷垪': '队列',
    '鍫嗘爤': '堆栈',
    '缂撳瓨': '缓存',
    '鍐呭瓨': '内存',
    '瀛樺偍': '存储',
    '纭洏': '硬盘',
    '纾佺洏': '磁盘',
    '鍒嗗尯': '分区',
    '鏂囦欢绯荤粺': '文件系统',
    '鏃ュ織鏂囦欢': '日志文件',
    '閰嶇疆鏂囦欢': '配置文件',
    '鍙彲鎵ц鏂囦欢': '可执行文件',
    '搴撴枃浠?': '库文件',
    '鍥惧儚鏂囦欢': '图像文件',
    '闊抽鏂囦欢': '音频文件',
    '瑙嗛鏂囦欢': '视频文件',
    '鏂囨湰鏂囦欢': '文本文件',
    '鍘嬬缉鏂囦欢': '压缩文件',
    '澶囦唤鏂囦欢': '备份文件',
    '涓存椂鏂囦欢': '临时文件',
    '缂撳瓨鏂囦欢': '缓存文件',
    '鏃ュ織': '日志'
};

/**
 * 特定中文乱码模式的正则表达式
 * 用于快速检测文本中是否包含需要修复的乱码
 */
const GARBLED_CHINESE_PATTERN = /鑴氭湰|鎵ц|閰嶇疆|鍒濆鍖|姝ｅ湪|瀹屾垚|閽卞寘|鑾峰彇|鎴愬姛|澶辫触/;

/**
 * 中文文本修复器类
 * 提供中文乱码检测和修复功能
 */
export class ChineseTextFixer {
    /**
     * 检测文本是否包含特定的中文乱码模式
     * @param {string} text - 待检测的文本
     * @returns {boolean} 是否包含乱码
     */
    static hasGarbledChinese(text) {
        if (typeof text !== 'string') return false;
        return GARBLED_CHINESE_PATTERN.test(text);
    }

    /**
     * 修复文本中的中文乱码
     * @param {string} text - 待修复的文本
     * @returns {string} 修复后的文本
     */
    static fixText(text) {
        if (typeof text !== 'string') return text;
        
        // 只对包含特定中文乱码模式的文本进行修复
        if (!this.hasGarbledChinese(text)) {
            return text; // 如果没有特定的中文乱码，直接返回原文本
        }
        
        let fixed = text;
        // 只处理确实包含乱码的部分
        for (const [garbled, correct] of Object.entries(CHINESE_FIX_MAP)) {
            if (fixed.includes(garbled)) {
                fixed = fixed.replace(new RegExp(garbled, 'g'), correct);
            }
        }
        return fixed;
    }

    /**
     * 带中文修复的控制台日志输出
     * @param {string} level - 日志级别 ('log', 'info', 'warn', 'error')
     * @param {...any} args - 日志参数
     */
    static logWithFix(level, ...args) {
        const fixedArgs = args.map(arg => {
            if (typeof arg === 'string') {
                return this.fixText(arg);
            }
            return arg;
        });
        
        switch (level) {
            case 'error':
                console.error('[脚本插件]', ...fixedArgs);
                break;
            case 'warn':
                console.warn('[脚本插件]', ...fixedArgs);
                break;
            case 'info':
                console.info('[脚本插件]', ...fixedArgs);
                break;
            default:
                console.log('[脚本插件]', ...fixedArgs);
        }
    }

    /**
     * 测试中文修复功能
     * @returns {boolean} 测试是否通过
     */
    static test() {
        const testText = "鎺ユ敹鍒拌幏鍙栬剼鏈垪琛ㄨ姹?";
        const fixedText = this.fixText(testText);
        const expected = "接收到获取脚本列表请求";
        
        const passed = fixedText === expected;
        console.log(`[中文修复] 测试${passed ? '通过' : '失败'}: "${testText}" -> "${fixedText}"`);
        return passed;
    }
}

/**
 * 设置全局中文修复功能
 * 在全局作用域注册修复函数，保持向后兼容性
 */
export function setupGlobalChineseTextFix() {
    // 创建全局的安全中文修复函数
    window.__fixChineseText = ChineseTextFixer.fixText.bind(ChineseTextFixer);
    
    // 只在脚本插件模块内部使用的受控修复功能
    window.__logWithChineseFix = ChineseTextFixer.logWithFix.bind(ChineseTextFixer);
    
    // 测试修复功能
    ChineseTextFixer.test();
    
    // console.log('[中文修复] ✅ 中文乱码修复功能已启用');
}

/**
 * 获取中文乱码映射表（只读）
 * @returns {Object} 乱码映射表的副本
 */
export function getChineseFixMap() {
    return { ...CHINESE_FIX_MAP };
}

// 默认导出
export default ChineseTextFixer; 