# 脚本插件模块优化方案

## 📋 项目概览

### 当前问题分析
- **架构混乱**: 多个管理器职责重叠，缺乏统一协调
- **脚本引擎缺陷**: VM2沙箱配置不安全，日志机制不稳定
- **状态管理问题**: 后台任务状态不一致，僵尸任务清理有bug
- **性能问题**: 大文件(3624行)，内存泄漏风险
- **代码质量**: 逻辑分散，难以维护

## 🎯 优化目标

### 核心目标
1. **架构清晰化**: 明确模块职责，减少耦合
2. **安全性增强**: 修复VM2沙箱安全问题
3. **稳定性提升**: 解决状态管理和任务执行问题
4. **性能优化**: 减少内存占用，提升响应速度
5. **代码质量**: 提高可维护性和可扩展性

## 🏗️ 新架构设计

### 核心模块职责划分

```
src/js/pages/batchScripts/
├── core/                           # 核心业务逻辑
│   ├── ScriptManager.js           # 脚本管理器 (统一入口)
│   ├── TaskStateManager.js       # 任务状态管理
│   ├── ExecutionEngine.js        # 执行引擎封装
│   └── LogManager.js              # 日志管理器
├── services/                       # 服务层
│   ├── ScriptService.js           # 脚本服务
│   ├── TaskService.js             # 任务服务
│   └── BackgroundTaskService.js   # 后台任务服务
├── components/                     # UI组件
│   ├── TaskExecutionPanel.js     # 任务执行面板
│   ├── LogViewer.js               # 日志查看器
│   └── (保留现有组件)
├── utils/                          # 工具函数
│   └── (保留现有工具)
└── index.js                       # 主入口(大幅简化)
```

### 职责分工

#### 1. ScriptManager (脚本管理器)
**职责**: 统一的脚本插件管理入口
- 脚本加载和缓存
- 脚本配置管理
- 脚本执行协调

#### 2. TaskStateManager (任务状态管理器)
**职责**: 集中管理所有任务状态
- 任务状态机实现
- 状态持久化
- 状态变更通知

#### 3. ExecutionEngine (执行引擎)
**职责**: 任务执行控制
- 并发控制
- 执行队列管理
- 错误处理和重试

#### 4. LogManager (日志管理器)
**职责**: 统一日志处理
- 日志收集和分发
- 日志持久化
- 日志查看器支持

## 📈 分阶段实施计划

### 第一阶段: 核心架构重构 (优先级: 高)

#### 1.1 创建核心管理器框架 (第1步)
- [ ] 创建 `core/ScriptManager.js`
- [ ] 创建 `core/TaskStateManager.js`
- [ ] 创建简单的状态管理接口

#### 1.2 重构脚本引擎安全性 (第2步)
- [ ] 修复 VM2 沙箱配置
- [ ] 改进日志传输机制
- [ ] 确保脚本执行安全性

#### 1.3 统一任务状态管理 (第3步)
- [ ] 重构后台任务状态管理
- [ ] 修复僵尸任务清理
- [ ] 实现状态一致性

### 第二阶段: 代码重构和优化 (优先级: 中)

#### 2.1 拆分大文件 (第4步)
- [ ] 将 `index.js` 拆分为多个模块
- [ ] 提取后台任务管理逻辑
- [ ] 重构页面初始化流程

#### 2.2 服务层重构 (第5步)
- [ ] 创建服务层抽象
- [ ] 重构数据访问层
- [ ] 优化 IPC 通信

### 第三阶段: 性能和体验优化 (优先级: 中)

#### 3.1 性能优化 (第6步)
- [ ] 优化日志渲染性能
- [ ] 实现懒加载机制
- [ ] 减少内存占用

#### 3.2 用户体验改进 (第7步)
- [ ] 改进错误处理和提示
- [ ] 优化界面响应性
- [ ] 增强操作反馈

## 🔧 技术实施细节

### 核心类设计

#### ScriptManager
```javascript
class ScriptManager {
    constructor() {
        this.scriptCache = new Map();
        this.stateManager = new TaskStateManager();
        this.executionEngine = new ExecutionEngine();
        this.logManager = new LogManager();
    }
    
    async loadScripts() { /* 脚本加载逻辑 */ }
    async executeScript(config) { /* 执行协调逻辑 */ }
    getScriptStatus(scriptId) { /* 状态查询 */ }
}
```

#### TaskStateManager
```javascript
class TaskStateManager {
    constructor() {
        this.states = new Map();
        this.observers = new Set();
        this.persistenceLayer = new TaskPersistence();
    }
    
    setState(taskId, state) { /* 状态设置 */ }
    getState(taskId) { /* 状态获取 */ }
    subscribe(callback) { /* 状态订阅 */ }
}
```

### 渐进式重构策略

#### 原则
1. **向后兼容**: 保持现有 API 不变
2. **逐步替换**: 一次只重构一个小模块
3. **功能验证**: 每步完成后确保功能正常
4. **最小影响**: 减少对其他模块的影响

#### 重构步骤
1. **创建新模块**: 不影响现有代码
2. **功能迁移**: 逐步将功能转移到新模块
3. **接口适配**: 保持现有接口兼容
4. **逐步替换**: 完成后替换旧代码
5. **清理代码**: 移除废弃代码

## 📊 质量保证

### 代码质量标准
- **单一职责**: 每个模块只负责一个核心功能
- **低耦合**: 模块间依赖最小化
- **高内聚**: 相关功能集中在同一模块
- **可测试**: 易于单元测试和集成测试

### 安全标准
- **沙箱隔离**: 脚本执行完全隔离
- **权限控制**: 最小权限原则
- **输入验证**: 严格的参数校验
- **错误处理**: 完善的异常处理机制

## 🎮 实施时间线

### 第一周: 核心架构
- Day 1-2: 创建核心管理器框架
- Day 3-4: 重构脚本引擎安全性
- Day 5-7: 统一任务状态管理

### 第二周: 代码重构
- Day 1-3: 拆分大文件
- Day 4-7: 服务层重构

### 第三周: 优化完善
- Day 1-4: 性能优化
- Day 5-7: 用户体验改进

## 📝 验收标准

### 功能验收
- [ ] 所有现有脚本功能正常运行
- [ ] 任务执行稳定可靠
- [ ] 后台任务管理正常
- [ ] 日志系统工作正常

### 质量验收
- [ ] 代码结构清晰，职责分明
- [ ] 无明显性能问题
- [ ] 内存占用合理
- [ ] 错误处理完善

### 安全验收
- [ ] 脚本沙箱安全可靠
- [ ] 敏感数据访问受控
- [ ] 无安全漏洞

---

**注意**: 本方案采用渐进式重构策略，确保在优化过程中不影响现有功能的正常使用。每个阶段完成后都会进行功能验证，确保系统稳定性。 