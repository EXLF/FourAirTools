# 全局验证码配置使用指南

## 📋 概述

为了简化脚本开发和使用体验，FourAir现已支持全局验证码配置功能。用户只需在全局设置中配置一次验证码服务，所有支持的脚本都可以自动使用这些配置，无需重复设置。

## 🎯 主要优势

### ✅ 用户体验提升
- **一次配置，多处使用**：在全局设置中配置一次，所有脚本自动使用
- **统一管理**：集中管理所有验证码服务的API Key
- **自动降级**：支持多个验证码服务的智能切换

### ✅ 开发者体验优化
- **简化脚本开发**：脚本开发者无需重复实现验证码逻辑
- **统一接口**：提供标准化的验证码解决工具
- **向后兼容**：现有脚本配置依然有效

## 🔧 用户配置指南

### 1. 全局设置配置

在应用的**设置页面**中找到**验证码服务**分组：

#### 基本配置
- **默认验证码服务**：选择主要使用的验证码服务（2Captcha 或 YesCaptcha）
- **2Captcha API Key**：输入2Captcha服务的API密钥
- **YesCaptcha API Key**：输入YesCaptcha服务的API密钥
- **启用验证码服务降级**：当主服务失败时自动切换到备用服务

#### 配置建议
```
✅ 推荐配置：
- 默认服务：根据个人偏好选择
- 至少配置一个API Key
- 启用服务降级（提高成功率）

💡 最佳实践：
- 同时配置两个服务的API Key
- 选择响应速度快、成功率高的服务作为默认
```

### 2. 脚本中的使用

#### 新版脚本使用方式

支持全局验证码的脚本通常包含以下配置选项：

```javascript
// 脚本配置示例
config: {
  useGlobalCaptcha: {
    type: "checkbox",
    label: "使用全局验证码配置",
    description: "优先使用全局设置中的验证码服务",
    default: true  // 默认启用
  },
  // 备用配置（仅在全局未配置时使用）
  captchaService: {
    type: "select",
    label: "验证码服务 (全局未配置时使用)",
    options: [
      { value: "2captcha", label: "2Captcha" },
      { value: "yescaptcha", label: "YesCaptcha" }
    ]
  }
}
```

#### 使用优先级

1. **全局配置优先**：如果启用了"使用全局验证码配置"且全局已配置，优先使用全局设置
2. **脚本配置备用**：如果全局未配置，使用脚本单独配置的验证码服务
3. **错误提示**：如果两者都未配置，脚本会提示用户进行配置

## 👨‍💻 开发者集成指南

### 1. 脚本配置修改

#### 更新配置参数
```javascript
// 原有配置（不推荐）
config: {
  captchaApiKey: {
    type: "text",
    label: "验证码API Key",
    required: true
  }
}

// 新版配置（推荐）
config: {
  useGlobalCaptcha: {
    type: "checkbox",
    label: "使用全局验证码配置",
    description: "优先使用全局设置中的验证码服务",
    default: true
  },
  // 备用配置
  captchaService: {
    type: "select",
    label: "验证码服务 (全局未配置时使用)",
    options: [
      { value: "2captcha", label: "2Captcha" },
      { value: "yescaptcha", label: "YesCaptcha" }
    ],
    required: false
  },
  captchaApiKey: {
    type: "text",
    label: "验证码API Key (全局未配置时使用)",
    placeholder: "请输入验证码API密钥",
    required: false
  }
}
```

### 2. 主函数更新

#### 获取全局验证码配置
```javascript
async function main(context) {
  // 获取全局验证码配置
  const { wallets, config, proxy, utils, http, globalCaptcha } = context;
  
  // 确定验证码服务配置
  let captchaService, apiKey;
  
  if (config.useGlobalCaptcha && globalCaptcha && globalCaptcha.isConfigured()) {
    // 使用全局配置
    captchaService = globalCaptcha.defaultService;
    apiKey = globalCaptcha.getApiKey();
    console.log(`🔧 使用全局验证码配置: ${captchaService}`);
  } else {
    // 使用脚本单独配置
    captchaService = config.captchaService;
    apiKey = config.captchaApiKey;
    
    if (!apiKey) {
      throw new Error('验证码API Key未配置，请在全局设置或脚本配置中设置');
    }
    
    console.log(`🔧 使用脚本配置的验证码服务: ${captchaService}`);
  }
}
```

### 3. 使用全局验证码工具

#### 简单使用方式
```javascript
// 最简单的使用方式 - 推荐
if (config.useGlobalCaptcha && globalCaptcha && globalCaptcha.isConfigured()) {
  const captchaToken = await globalCaptcha.solveTurnstile(
    'https://example.com',      // 网站URL
    '0x4AAAAAAA6vnrvBCtS4FAl-', // 站点密钥
    userAgent,                   // User-Agent (可选)
    proxy,                       // 代理配置 (可选)
    utils                        // 工具函数
  );
  
  if (captchaToken) {
    console.log('✅ 验证码解决成功');
    // 使用验证码token继续后续操作
  } else {
    console.log('❌ 验证码解决失败');
  }
}
```

#### 完整的降级处理
```javascript
async function solveCaptcha(siteUrl, siteKey, userAgent, proxy, utils) {
  let captchaToken = null;
  
  // 优先使用全局验证码工具
  if (config.useGlobalCaptcha && globalCaptcha && globalCaptcha.isConfigured()) {
    console.log('🔐 使用全局验证码工具...');
    captchaToken = await globalCaptcha.solveTurnstile(siteUrl, siteKey, userAgent, proxy, utils);
  }
  
  // 降级到脚本内验证码逻辑
  if (!captchaToken && apiKey) {
    console.log('🔄 降级使用脚本内验证码逻辑...');
    captchaToken = await solveWithCustomLogic(siteUrl, siteKey, captchaService, apiKey, utils);
  }
  
  if (!captchaToken) {
    throw new Error('验证码解决失败，请检查配置');
  }
  
  return captchaToken;
}
```

### 4. 全局验证码API参考

#### globalCaptcha 对象属性
```javascript
globalCaptcha = {
  defaultService: 'string',        // 默认验证码服务 ('2captcha' | 'yescaptcha')
  twoCaptchaApiKey: 'string',     // 2Captcha API Key
  yescaptchaApiKey: 'string',     // YesCaptcha API Key
  enableFallback: 'boolean',      // 是否启用服务降级
  
  // 方法
  getApiKey(service?: string): string,           // 获取指定服务的API Key
  isConfigured(service?: string): boolean,       // 检查服务是否已配置
  solveTurnstile(siteUrl, siteKey, userAgent?, proxy?, utils): Promise<string | null>
}
```

#### 主要方法说明

##### `getApiKey(service)`
- **功能**：获取指定验证码服务的API Key
- **参数**：service (可选) - 验证码服务名称，不传则使用默认服务
- **返回**：API Key字符串

##### `isConfigured(service)`
- **功能**：检查指定验证码服务是否已配置
- **参数**：service (可选) - 验证码服务名称，不传则使用默认服务
- **返回**：boolean - 是否已配置

##### `solveTurnstile(siteUrl, siteKey, userAgent, proxy, utils)`
- **功能**：解决Turnstile验证码
- **参数**：
  - siteUrl: 网站URL
  - siteKey: Turnstile站点密钥
  - userAgent: User-Agent字符串 (可选)
  - proxy: 代理配置对象 (可选)
  - utils: 工具函数对象 (必需，用于延时等)
- **返回**：验证码token字符串或null

## 📝 迁移指南

### 现有脚本迁移

#### 步骤1：更新配置参数
将原有的必填验证码配置改为可选，并添加全局配置选项。

#### 步骤2：修改主函数逻辑
在主函数中添加全局验证码配置的检查和使用逻辑。

#### 步骤3：保持向后兼容
确保在全局未配置时，脚本仍可使用原有的单独配置。

#### 步骤4：测试验证
测试在不同配置状态下的脚本行为：
- 仅全局配置
- 仅脚本配置  
- 两者都配置
- 两者都未配置

## ❓ 常见问题

### Q: 全局配置和脚本配置同时存在时，哪个优先？
A: 如果脚本启用了"使用全局验证码配置"且全局已配置，则优先使用全局配置。

### Q: 可以在脚本运行时切换验证码服务吗？
A: 验证码服务在脚本开始时确定，运行过程中不会切换。但全局工具支持自动降级。

### Q: 全局配置的API Key如何保存？
A: API Key以加密方式保存在应用的设置文件中，确保安全性。

### Q: 旧脚本是否需要更新？
A: 不是必需的。旧脚本的原有配置方式依然有效，但建议更新以获得更好的用户体验。

### Q: 如何调试验证码相关问题？
A: 可以在脚本中检查 `globalCaptcha.isConfigured()` 状态，查看控制台日志了解验证码解决过程。

## 🔄 更新记录

- **2024-12-19**：初始版本发布
  - 支持2Captcha和YesCaptcha两种服务
  - 提供完整的全局配置和脚本集成方案
  - 包含示例脚本和完整文档

---

通过全局验证码配置功能，FourAir为用户和开发者都提供了更好的体验。用户无需重复配置，开发者可以专注于脚本核心逻辑的开发。 